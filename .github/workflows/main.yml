name: CI
env:
  VK_VERSION: 1.2.176.1
on:
  push:
    branches:
      - master

jobs:
  Linux:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

      - name: Install required packages
        shell: bash
        run: |
          sudo apt-get -qq update
          sudo apt-get install -y make gcc g++ mesa-common-dev libglu1-mesa-dev libxxf86dga-dev libxxf86vm-dev libasound2-dev libx11-dev libxcb1-dev
      - name: Download and Install Vulkan SDK
        shell: bash
        run: |
          curl -L -v -o vulkansdk-linux-x86_64-$VK_VERSION.tar.gz -O https://sdk.lunarg.com/sdk/download/$VK_VERSION/linux/vulkan_sdk.tar.gz?Human=true
          tar zxf vulkansdk-linux-x86_64-$VK_VERSION.tar.gz
      - name: Build vkQuake2 Debug
        shell: bash
        run: |
          export VULKAN_SDK=$GITHUB_WORKSPACE/$VK_VERSION/x86_64
          cd linux
          make clean debug
          cd ..
      - name: Upload vkQuake2 Debug artifacts
        uses: actions/upload-artifact@v2.1.3
        with:
          name: vkQuake2-Ubuntu-debug-x64
          path: |
            linux/debugx64
            !linux/debugx64/**/*.o
      - name: Build vkQuake2 Release
        shell: bash
        run: |
          export VULKAN_SDK=$GITHUB_WORKSPACE/$VK_VERSION/x86_64
          cd linux
          make clean release
          cd ..
      - name: Upload vkQuake2 Release artifacts
        uses: actions/upload-artifact@v2.1.3
        with:
          name: vkQuake2-Ubuntu-release-x64
          path: |
            linux/releasex64
            !linux/releasex64/**/*.o
  MacOS:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2
      
      - name: Install Vulkan SDK
        uses: humbletim/install-vulkan-sdk@v1.1.1
        with:
          version: 1.3.204.0
          cache: true
      - name: Build vkQuake2 Debug
        run: |
          cd macos
          make clean-xcode debug-xcode
          cd ..
      - name: Upload vkQuake2 Debug artifacts
        uses: actions/upload-artifact@v2.1.3
        with:
          name: vkQuake2-MacOS-debug-x64
          path: |
            macos/vkQuake2
            !macos/vkQuake2/**/*.o
      - name: Build vkQuake2 Release
        run: |
          cd macos
          make clean-xcode release-xcode
          cd ..
      - name: Upload vkQuake2 Release artifacts
        uses: actions/upload-artifact@v2.1.3
        with:
          name: vkQuake2-MacOS-release-x64
          path: |
            macos/vkQuake2
            !macos/vkQuake2/**/*.o
  Windows:
    env:
      VULKAN_SDK: c:\VulkanSDK\%VK_VERSION%
    runs-on: windows-2022

    steps:
    - uses: microsoft/setup-msbuild@v1.1
    - uses: actions/checkout@v2

    - name: Download Vulkan SDK
      shell: powershell
      run: curl -v -o VulkanSDK.exe https://sdk.lunarg.com/sdk/download/$env:VK_VERSION/windows/vulkan_sdk.exe?Human=true
    - name: Install Vulkan SDK
      shell: cmd
      run: .\VulkanSDK.exe /S
    - name: Build vkQuake2 Debug (x86)
      run: msbuild quake2.sln /m /t:Rebuild /p:Configuration=Debug /p:Platform=x86
    - name: Upload vkQuake2 Debug (x86) artifacts
      uses: actions/upload-artifact@v2.1.3
      with:
        name: vkQuake2-Windows-debug-x86
        path: |
          Quake2
          !Quake2/**/*.obj
          !Quake2/**/*.exp
          !Quake2/**/*.ilk
          !Quake2/**/*.lib
          !Quake2/**/*.pdb
          !Quake2/**/*.iobj
          !Quake2/**/*.ipdb
    - name: Build vkQuake2 Release (x86)
      run: msbuild quake2.sln /m /t:Rebuild /p:Configuration=Release /p:Platform=x86
    - name: Upload vkQuake2 Release (x86) artifacts
      uses: actions/upload-artifact@v2.1.3
      with:
        name: vkQuake2-Windows-release-x86
        path: |
          Quake2
          !Quake2/**/*.obj
          !Quake2/**/*.exp
          !Quake2/**/*.ilk
          !Quake2/**/*.lib
          !Quake2/**/*.pdb
          !Quake2/**/*.iobj
          !Quake2/**/*.ipdb
    - name: Build vkQuake2 Debug (x64)
      run: msbuild quake2.sln /m /t:Rebuild /p:Configuration=Debug /p:Platform=x64
    - name: Upload vkQuake2 Debug (x64) artifacts
      uses: actions/upload-artifact@v2.1.3
      with:
        name: vkQuake2-Windows-debug-x64
        path: |
          Quake2
          !Quake2/**/*.obj
          !Quake2/**/*.exp
          !Quake2/**/*.ilk
          !Quake2/**/*.lib
          !Quake2/**/*.pdb
          !Quake2/**/*.iobj
          !Quake2/**/*.ipdb
    - name: Build vkQuake2 Release (x64)
      run: msbuild quake2.sln /m /t:Rebuild /p:Configuration=Release /p:Platform=x64
    - name: Upload vkQuake2 Release (x64) artifacts
      uses: actions/upload-artifact@v2.1.3
      with:
        name: vkQuake2-Windows-release-x64
        path: |
          Quake2
          !Quake2/**/*.obj
          !Quake2/**/*.exp
          !Quake2/**/*.ilk
          !Quake2/**/*.lib
          !Quake2/**/*.pdb
          !Quake2/**/*.iobj
          !Quake2/**/*.ipdb
